{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">سندات القبض والصرف</h3>
  </div>

  <div class="d-flex gap-2 mb-3">
    <a class="btn btn-outline-primary" href="{% url 'account:receipts_report' %}">تقرير سندات القبض</a>
    <a class="btn btn-outline-primary" href="{% url 'account:disbursements_report' %}">تقرير سندات الصرف</a>
  </div>


  <div class="card shadow-sm mb-4">
    <div class="card-header fw-bold">
      إضافة سند جديد
    </div>
    <div class="card-body">

      <form method="post" novalidate>
        {% csrf_token %}

        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">النوع</label>
            {{ form.payment_type }}
          </div>

          <div class="col-md-3">
            <label class="form-label">التاريخ</label>
            {{ form.date }}
          </div>

          <div class="col-md-3" id="customer-field">
            <label class="form-label">العميل</label>
            {{ form.customer }}
          </div>

          <div class="col-md-3" id="supplier-field">
            <label class="form-label">المورد</label>
            {{ form.supplier }}
          </div>

          <div class="col-md-3" id="cash-account-field">
            <label class="form-label">حساب الصندوق/البنك</label>
            {{ form.cash_account }}
          </div>

          <div class="col-md-3">
            <label class="form-label">المبلغ</label>
            {{ form.amount }}
          </div>

          <div class="col-md-9">
            <label class="form-label">ملاحظة</label>
            {{ form.note }}
          </div>
        </div>

        <div class="mt-3 d-flex gap-2">
          <button type="submit" class="btn btn-primary">
            حفظ وترحيل
          </button>
          <a href="{% url 'account:payments' %}" class="btn btn-outline-secondary">تفريغ</a>
        </div>

        {% if form.errors %}
          <div class="alert alert-danger mt-3">
            {{ form.errors }}
          </div>
        {% endif %}
      </form>

    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header fw-bold">
      آخر السندات
    </div>
    <div class="card-body p-0">

      <div class="table-responsive">
        <table class="table table-striped table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>رقم السند</th>
              <th>التاريخ</th>
              <th>النوع</th>
              <th>الطرف</th>
              <th>المبلغ</th>
              <th>القيد المرتبط</th>
              <th class="text-center">طباعة</th>
            </tr>
          </thead>
          <tbody>
            {% for p in payments %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>
                  {{ p.voucher_number|default:p.id }}
                </td>
                <td>{{ p.date }}</td>
                <td>
                  {% if p.payment_type == "RECEIPT" %}
                    <span class="badge bg-success">قبض</span>
                  {% else %}
                    <span class="badge bg-danger">صرف</span>
                  {% endif %}
                </td>
                <td>
                  {% if p.customer %}
                    {{ p.customer.name }}
                  {% elif p.supplier %}
                    {{ p.supplier.name }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>{{ p.amount }}</td>
                <td>
                  {% if p.journal_entry %}
                    {{ p.journal_entry.serial_number|default:p.journal_entry.id }}
                  {% else %}
                    <span class="text-muted">غير مرحّل</span>
                  {% endif %}
                </td>
                <td class="text-center">
                  <a class="btn btn-sm btn-outline-dark" target="_blank"
                     href="{% url 'account:payment_pdf' p.id %}">
                    PDF
                  </a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="8" class="text-center text-muted py-4">لا يوجد سندات بعد</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    </div>
  </div>

</div>

<script>
(function () {
  const typeEl = document.getElementById("id_payment_type");
  const custWrap = document.getElementById("id_customer");
  const suppWrap = document.getElementById("id_supplier");

  function toggleParty() {
    const val = typeEl ? typeEl.value : "";
    if (!custWrap || !suppWrap) return;

    if (val === "RECEIPT") {
      custWrap.closest(".col-md-3").style.display = "";
      suppWrap.closest(".col-md-3").style.display = "none";
      suppWrap.value = "";
    } else if (val === "DISBURSE") {
      suppWrap.closest(".col-md-3").style.display = "";
      custWrap.closest(".col-md-3").style.display = "none";
      custWrap.value = "";
    } else {
      custWrap.closest(".col-md-3").style.display = "";
      suppWrap.closest(".col-md-3").style.display = "";
    }
  }

  if (typeEl) {
    typeEl.addEventListener("change", toggleParty);
    toggleParty();
  }
})();
</script>

<script>
  (function () {
    const typeEl = document.getElementById("id_payment_type");
    const customerWrap = document.getElementById("customer-field");
    const supplierWrap = document.getElementById("supplier-field");
    const customerEl = document.getElementById("id_customer");
    const supplierEl = document.getElementById("id_supplier");

    function syncPartyFields() {
      const v = (typeEl?.value || "").toUpperCase();

      if (v === "RECEIPT") {
        if (customerWrap) customerWrap.style.display = "";
        if (supplierWrap) supplierWrap.style.display = "none";
        if (supplierEl) supplierEl.value = "";
      } else if (v === "DISBURSE") {
        if (supplierWrap) supplierWrap.style.display = "";
        if (customerWrap) customerWrap.style.display = "none";
        if (customerEl) customerEl.value = "";
      } else {
        // fallback
        if (customerWrap) customerWrap.style.display = "";
        if (supplierWrap) supplierWrap.style.display = "";
      }
    }

    if (typeEl) {
      typeEl.addEventListener("change", syncPartyFields);
      // initial run
      syncPartyFields();
    }
  })();
</script>

{% endblock %}
